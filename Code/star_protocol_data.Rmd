---
title: "star protocol roi data from 3.6 segmentation"
output: html_document
date: "2024-11-19"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
#1) Install and upload the libraries of the packages we will use for the code below:

# Function to check if a package is installed and install it if not
install_if_missing <- function(pkg) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    install.packages(pkg, dependencies = TRUE)
  }
  require(pkg, character.only = TRUE)
}

packages <- c(
  "plyr", "tidyverse", "ggpubr", "readxl", "kableExtra", "ggplot2",
  "dplyr", "stringr", "tidyr", "RColorBrewer", "forcats",
  "gridExtra", "pwr", "broom", "gt", "glue", "knitr", "broom", "pwr", "pheatmap",
  "ComplexHeatmap", "circlize", "gridExtra", "circlize", "grid", "plotly", "webshot2", 
  "stringr", "ggalt", "ggpubr", "rstatix", "forcats", "gplots",
  "remotes", "AbiMatrix", "Cardinal", "EBImage", "reshape2" # Additional packages
)

# Load or install the necessary packages
sapply(packages, install_if_missing)

```


Setting up the working directory
```{r}
#If using your own working directory, comment the one below (DO NOT DELETE IT) and your own working directory:
setwd("/Users/isaacmarin-valencia/Desktop/STAR_Protocol/Excel_files")

```

Get ROI
```{r}
#setwd("~/Library/CloudStorage/OneDrive-TheMountSinaiHospital/Watit - BigPC/mouse-histology/control_cv")
c5_brain <- getSegmentROI(c5_ssc, cluster = 4, select_classes = c(1:3,5:13,15:20))
c5_cortex <- getSegmentROI(c5_ssc, cluster = 5, select_classes = c(6,8), select_target = 1)
c5_hippo <- getSegmentROI(c5_ssc, cluster = 5, select_classes = c(7,8,11), select_target = 8)
c5_cereb <- getSegmentROI(c5_ssc, cluster = 4, select_classes = c(2,5,15,16,17,19), select_target = 2)
```


```{r}
#setwd("~/Library/CloudStorage/OneDrive-TheMountSinaiHospital/Watit - BigPC/mouse-histology/control_cv")
c9_brain <- getSegmentROI(c9_ssc, cluster = 1, select_classes = c(1:8,10,12:19))
c9_cortex <- fillHull(getSegmentROI(c9_ssc, cluster = 1, select_classes = c(7,5), select_target = 1) +
  getSegmentROI(c9_ssc, cluster = 1, select_classes = c(7), select_target = 3) +
  getSegmentROI(c9_ssc, cluster = 1, select_classes = c(6), select_target = 2) +
  getSegmentROI(c9_ssc, cluster = 1, select_classes = c(8), select_target = 2) +
  getSegmentROI(c9_ssc, cluster = 1, select_classes = c(12), select_target = 1))
c9_cortex <- c9_cortex > 0
c9_hippo <- getSegmentROI(c9_ssc, cluster = 4, select_classes = c(6,10,15), select_target = 5)
c9_cereb <- getSegmentROI(c9_ssc, cluster = 1, select_classes = c(13,14), select_target = 1)
```


```{r}
#setwd("~/Library/CloudStorage/OneDrive-TheMountSinaiHospital/Watit - BigPC/mouse-histology/control_cv")
c10_brain <- getSegmentROI(c10_ssc, cluster = 3, select_classes = c(2:5, 7:13,15:20))
c10_cortex <- getSegmentROI(c10_ssc, cluster = 4, select_classes = c(5,12), select_target = 1)
c10_hippo <- getSegmentROI(c10_ssc, cluster = 4, select_classes = c(2,5,10,12), select_target = 13)
c10_cereb <- fillHull(getSegmentROI(c10_ssc, cluster = 4, select_classes = c(10,13,15,18), select_target = 1) +
  getSegmentROI(c10_ssc, cluster = 4, select_classes = c(10,13,15,18), select_target = 2) +
  getSegmentROI(c10_ssc, cluster = 4, select_classes = c(10,13,15,18), select_target = 3) +
  getSegmentROI(c10_ssc, cluster = 4, select_classes = c(9), select_target = 2))
c10_cereb <- c10_cereb > 0
```

resize image

```{r}

matchSize <- function(img, target) {
  
  w <- max(target@elementMetadata$x)
  h <- max(target@elementMetadata$y)
  
  resized_img <- resize(img, w, h)
  
  if (is.logical(img)) {
    resized_img <- resized_img > 0
  }
  
  return(resized_img)
}

c5_cereb <- matchSize(c5_cereb, c5_mse_proc)
c5_cortex <- matchSize(c5_cortex, c5_mse_proc)
c5_hippo <- matchSize(c5_hippo, c5_mse_proc)

c9_cereb <- matchSize(c9_cereb, c9_mse_proc)
c9_cortex <- matchSize(c9_cortex, c9_mse_proc)
c9_hippo <- matchSize(c9_hippo, c9_mse_proc)

c10_cereb <- matchSize(c10_cereb, c10_mse_proc)
c10_cortex <- matchSize(c10_cortex, c10_mse_proc)
c10_hippo <- matchSize(c10_hippo, c10_mse_proc)
```

Add ROIs to MSI objects

```{r}
c5_rois <- c("c5_cortex", "c5_hippo", "c5_cereb")
c5_roi_list <- mget(c5_rois)
c5_mse_proc <- assignROI(c5_mse_proc, c5_roi_list)

c9_rois <- c("c9_cortex", "c9_hippo", "c9_cereb")
c9_roi_list <- mget(c9_rois)
c9_mse_proc <- assignROI(c9_mse_proc, c9_roi_list)

c10_rois <- c("c10_cortex", "c10_hippo", "c10_cereb")
c10_roi_list <- mget(c10_rois)
c10_mse_proc <- assignROI(c10_mse_proc, c10_roi_list)
```

Check data

```{r}
# Alanine
c5_ala_msi <- image(c5_mse_proc, mz = c(90.055509, 92.071169), subset=c5_mse_proc$c5_cereb, enhance="adaptive", scale=TRUE)
# GABA
c5_gaba_msi <- image(c5_mse_proc, mz = c(104.071159, 106.086819), subset=c5_mse_proc$c5_cereb, enhance="adaptive", scale=TRUE)
# Aspartate
c5_asp_msi <- image(c5_mse_proc, mz = c(134.045339, 136.045999), subset=c5_mse_proc$c5_cereb, enhance="adaptive", scale=TRUE)
# Glutamate
c5_glu_msi <- image(c5_mse_proc, mz = c(147.076973, 149.082633), subset=c5_mse_proc$c5_cereb, enhance="adaptive", scale=TRUE)
#c5_glu_msi <- image(c5_mse_proc, mz = c(147.076973, 148.074803,	149.082633,	150.090463,	151.118293,	152.106123), subset=c5_mse_proc$c5_cereb, enhance="adaptive", scale=TRUE)
# Glutamine
c5_gln_msi <- image(c5_mse_proc, mz = c(148.060989, 150.06649), subset=c5_mse_proc$c5_cereb, enhance="adaptive", scale=TRUE)
#c5_gln_msi <- image(c5_mse_proc, mz = c(148.060989,	149.068819,	150.066649,	151.094479,	152.102309,	153.100139), subset=c5_mse_proc$c5_cereb, enhance="adaptive", scale=TRUE)

# GABA - c9
c9_gaba_msi <- image(c9_mse_proc, mz = c(104.071159, 106.086819), subset=c9_mse_proc$c9_cereb, enhance="adaptive", scale=TRUE)
# Aspartate - c9
c9_asp_msi <- image(c9_mse_proc, mz = c(134.045339, 136.045999), subset=c9_mse_proc$c9_cereb, enhance="adaptive", scale=TRUE)
# Glutamate - c9
c9_glu_msi <- image(c9_mse_proc, mz = c(147.076973, 149.082633), subset=c9_mse_proc$c9_cereb, enhance="adaptive", scale=TRUE)
#c9_glu_msi <- image(c9_mse_proc, mz = c(147.076973, 148.074803,	149.082633,	150.090463,	151.118293,	152.106123), subset=c9_mse_proc$c9_cereb, enhance="adaptive", scale=TRUE)
# Glutamine - c9
c9_gln_msi <- image(c9_mse_proc, mz = c(148.060989, 150.06649), subset=c9_mse_proc$c9_cereb, enhance="adaptive", scale=TRUE)
#c9_gln_msi <- image(c9_mse_proc, mz = c(148.060989,	149.068819,	150.066649,	151.094479,	152.102309,	153.100139), subset=c9_mse_proc$c9_cereb, enhance="adaptive", scale=TRUE)

# GABA - c10
c10_gaba_msi <- image(c10_mse_proc, mz = c(104.071159, 106.086819), subset=c10_mse_proc$c10_cereb, enhance="adaptive", scale=TRUE)
# Aspartate - c10
c10_asp_msi <- image(c10_mse_proc, mz = c(134.045339, 136.045999), subset=c10_mse_proc$c10_cereb, enhance="adaptive", scale=TRUE)
# Glutamate - c10
c10_glu_msi <- image(c10_mse_proc, mz = c(147.076973, 149.082633), subset=c10_mse_proc$c10_cereb, enhance="adaptive", scale=TRUE)
#c10_glu_msi <- image(c10_mse_proc, mz = c(147.076973, 148.074803,	149.082633,	150.090463,	151.118293,	152.106123), subset=c10_mse_proc$c10_cereb, enhance="adaptive", scale=TRUE)
# Glutamine - c10
c10_gln_msi <- image(c10_mse_proc, mz = c(148.060989, 150.06649), subset=c10_mse_proc$c10_cereb, enhance="adaptive", scale=TRUE)
#c10_gln_msi <- image(c10_mse_proc, mz = c(148.060989,	149.068819,	150.066649,	151.094479,	152.102309,	153.100139), subset=c10_mse_proc$c10_cereb, enhance="adaptive", scale=TRUE)
```

Create function to extract the tic

```{r}
getROITIC <- function(msi, roi_list, normalize = TRUE, decimal = 4, verbose = FALSE) {
  df <- NULL
  for (name in names(roi_list)) {
    if (verbose) {
      cat("Get TIC from ROI:", name, "\n")
    }
    tic <- fData(summarizeFeatures(msi, stat="sum", groups=msi[[name]], verbose = FALSE))
    if (is.null(df)) {
      df <- data.frame(mz = as.numeric(format(round(as.matrix(tic[,"mz"]), decimal), nsmall = decimal)))
    }

    if (normalize) {
      new_df <- data.frame(tic = as.matrix(tic[,"TRUE.sum"])/sum(roi_list[[name]]))

    } else {
      new_df <- data.frame(tic = as.matrix(tic[,"TRUE.sum"]))
    }

    colnames(new_df) <- name
    df <- cbind(df, new_df)
  }
  return(df)
}

```

Extract TIC from MSI objects

```{r}
c5_data <- getROITIC(c5_mse_proc, c5_roi_list, normalize = FALSE)
c9_data <- getROITIC(c9_mse_proc, c9_roi_list, normalize = FALSE)
c10_data <- getROITIC(c10_mse_proc, c10_roi_list, normalize = FALSE)

c5_ndata <- getROITIC(c5_mse_proc, c5_roi_list, normalize = TRUE)
c9_ndata <- getROITIC(c9_mse_proc, c9_roi_list, normalize = TRUE)
c10_ndata <- getROITIC(c10_mse_proc, c10_roi_list, normalize = TRUE)
```

Create data frame for reproducibility

```{r}
tic_list <- mget(c("c5_data", "c9_data", "c10_data"))
col_list <- c("Cortex", "Hippocampus", "Cerebellum")
cv_df <- buildCVDataframe(tic_list, col_list)
cv <- getCV(cv_df, col_list, na.rm = TRUE, outline.rm = TRUE, noise.rm = TRUE)

ggplot(cv, aes(x = Region, y = CV, fill = Region)) +
  geom_errorbar(aes(ymin = CV - 3*SD, ymax = CV + 3*SD), width = 0.2) +
  geom_boxplot(aes(lower=CV-SD, upper=CV+SD, middle=CV, ymin=CV-3*SD, ymax=CV+3*SD), 
               stat = "identity",) +
  labs(title = "Coefficient of Variation by Region",
       x = "Region",
       y = "CV (%)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(hjust = 0.5))
```


Create some function for filtering data:
```{r}
filterMetaboliteTIC <- function(msi_df, ion_list, tracing=NULL) {
  msi_tic <- list()
  if (is.data.frame(ion_list)) {
    metabolite_names <- ion_list[, unlist(lapply(ion_list, is.character), use.names = FALSE)]
    mass_list <- ion_list[, unlist(lapply(ion_list, is.numeric), use.names = FALSE)]
    if (!is.null(tracing)) {
      new_names <- NULL
      new_masses <- NULL
      new_df <- NULL
      for (i in tracing) {
        new_names <- c(new_names, paste0(metabolite_names,"_M",i))
        new_masses <- c(new_masses, mass_list + (i*1.00783))
      }
      new_df <- data.frame(Metabolite=new_names, mz=new_masses)
      new_df[order(new_df$Metabolite),]
      metabolite_names <- new_df$Metabolite
      mass_list <- new_df$mz
    }
    
    head_col <- data.frame(Metabolite=metabolite_names, mz=mass_list)
  } else {
    mass_list <- ion_list
    head_col <- data.frame(mz=mass_list)
  }
  
  for (i in seq_along(mass_list)) {
    mass <- mass_list[i]
    row_number <- which.min(abs(msi_df$mz - mass))
    col_number <- which(colnames(msi_df)=="mz") + 1
    new_tic <- cbind(head_col[i, , drop=FALSE], msi_df[row_number, col_number:ncol(msi_df)])
    msi_tic <- rbind(msi_tic, new_tic)
  }

  return(msi_tic)
}

```


Compile in one dataframe for selected compounds:
```{r}
tic_list <- mget(c("c5_data", "c9_data", "c10_data"))
col_list <- c("Cortex", "Hippocampus", "Cerebellum")
customed_metabolites <- data.frame(
  Metabolite = c("GABA_M0", "GABA_M2", "Aspartate_M0", "Aspartate_M2",  "Glutamate_M0", "Glutamate_M2", "Glutamine_M0", "Glutamine_M2"),
  Mass = c(104.071159, 106.086819, 134.045339, 136.060999, 147.076973, 149.082633, 148.060989, 150.06649)
)

c5_filtered <- filterMetaboliteTIC(c5_data, customed_metabolites)
c9_filtered <- filterMetaboliteTIC(c9_data, customed_metabolites)
c10_filtered <- filterMetaboliteTIC(c10_data, customed_metabolites)

merged_df <- merge(merge(c5_filtered, c9_filtered), c10_filtered)

c5_nfiltered <- filterMetaboliteTIC(c5_ndata, customed_metabolites)
c9_nfiltered <- filterMetaboliteTIC(c9_ndata, customed_metabolites)
c10_nfiltered <- filterMetaboliteTIC(c10_ndata, customed_metabolites)

merged_ndf <- merge(merge(c5_nfiltered, c9_nfiltered), c10_nfiltered)
```


Plot:
```{r}
# filter GABA data
gaba_data <- merged_df[grep("GABA", merged_df$Metabolite), ]

# reshape the data for easier plotting
gaba_long <- melt(
  gaba_data,
  id.vars = c("Metabolite", "mz"),
  variable.name = "Region",
  value.name = "Intensity"
)

# extract Region and Sample details from column names
gaba_long <- gaba_long %>%
  mutate(
    Metabolite = sub(".*_(M[0-9]+)", "\\1", Metabolite),
    Sample = sub("_.*", "", Region),        # extract sample name (e.g., "c5", "c9", "c10")
    Region = gsub("c[0-9]+_", "", Region)  # remove sample prefixes to get region names
  )

# compute summary statistics (mean and standard error) for each group
summary_data <- gaba_long %>%
  group_by(Metabolite, Region) %>%
  summarize(
    Mean = mean(Intensity, na.rm = TRUE),
    SE = sd(Intensity, na.rm = TRUE) / sqrt(n()),  # Standard error
    .groups = "drop"
  )

# create the plot
ggplot(summary_data, aes(x = Region, y = Mean, fill = Metabolite)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9), color = "black", width = 0.7) +  # Bar plot
  geom_errorbar(aes(ymin = Mean - SE, ymax = Mean + SE), position = position_dodge(width = 0.9), width = 0.2) +  # Error bars
  geom_jitter(data = gaba_long, aes(x = Region, y = Intensity, color = Metabolite), 
              position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), size = 2, alpha = 0.8) +  # Dots for individual points
  scale_fill_brewer(palette = "Set1") +  # customize bar colors
  scale_color_brewer(palette = "Set1") +  # match dot colors to bar colors
  theme_minimal() +
  labs(
    title = "GABA Intensities Across Regions",
    x = "Brain Region",
    y = "Normalized Intensity",
    fill = "Isotopologues",
    color = "Isotopologues"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(size = 16),  # Increase x-axis title size
        axis.title.y = element_text(size = 16),  # Increase y-axis title size
        plot.title = element_text(size = 18, hjust = 0.5)  # Increase title size and center it
        )
```


Let create function and applied to all other metabolites:
```{r}
plotMetabolite <- function(data, metabolite_name) {
  # filter data for the specified metabolite
  metabolite_data <- data[grep(metabolite_name, data$Metabolite), ]
  
  # reshape the data for easier plotting
  metabolite_long <- melt(
    metabolite_data,
    id.vars = c("Metabolite", "mz"),
    variable.name = "Region",
    value.name = "Intensity"
  )
  
  # extract Region and Sample details from column names
  metabolite_long <- metabolite_long |>
    mutate(
      Metabolite = sub(".*_(M[0-9]+)", "\\1", Metabolite),
      Sample = sub("_.*", "", Region),        # Extract sample name (e.g., "c5", "c9", "c10")
      Region = gsub("c[0-9]+_", "", Region)  # Remove sample prefixes to get region names
    )
  
  # compute summary statistics (mean and standard error) for each group
  summary_data <- metabolite_long |>
    group_by(Metabolite, Region) |>
    summarize(
      Mean = mean(Intensity, na.rm = TRUE),
      SE = sd(Intensity, na.rm = TRUE) / sqrt(n()),  # Standard error
      .groups = "drop"
    )
  
  ggplot(summary_data, aes(x = Region, y = Mean, fill = Metabolite)) +
    geom_bar(stat = "identity", position = position_dodge(width = 0.9), color = "black", width = 0.7) +  # Bar plot
    geom_errorbar(aes(ymin = Mean - SE, ymax = Mean + SE), position = position_dodge(width = 0.9), width = 0.2) +  # Error bars
    geom_jitter(data = metabolite_long, aes(x = Region, y = Intensity, fill = Metabolite), 
                position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), shape = 21, size = 2, color = "black", alpha = 0.8) +  # Dots for individual points
    scale_fill_brewer(palette = "Set1") +  # Customize bar colors
    scale_color_brewer(palette = "Set1") +  # Match dot colors to bar colors
    theme_minimal() +
    labs(
      title = paste(metabolite_name, "Abundances Across Regions"),
      x = "Brain Region",
      y = paste0(metabolite_name," Intensities"),
      fill = "Isotopologue",
      color = "Isotopologue"
    ) +
    theme(
      axis.text.x = element_text(size = 16, angle = 45, hjust = 1),  # Increase size of x-axis labels
      axis.title.x = element_text(size = 18),  # Increase size of x-axis title
      axis.title.y = element_text(size = 18),  # Increase size of y-axis title
      plot.title = element_text(size = 20, hjust = 0.5)  # Increase size of title and center it
    )
}

# Plot examples
p_gaba <- plotMetabolite(merged_df, "GABA")
p_asp <- plotMetabolite(merged_df, "Aspartate")
p_glu <- plotMetabolite(merged_df, "Glutamate")
p_gln <- plotMetabolite(merged_df, "Glutamine")

p_ngaba <- plotMetabolite(merged_ndf, "GABA")
p_nasp <- plotMetabolite(merged_ndf, "Aspartate")
p_nglu <- plotMetabolite(merged_ndf, "Glutamate")
p_ngln <- plotMetabolite(merged_ndf, "Glutamine")
```

Create new enrichment dataframe

```{r}
normalizeTracer <- function(data) {
  # Step 1: Calculate totals for each base metabolite
  totals_df <- data %>%
    mutate(BaseMetabolite = gsub("_M[0-9]+$", "", Metabolite)) %>%
    group_by(BaseMetabolite) %>%
    summarize(across(where(is.numeric), sum), .groups = "drop") %>%
    rename_with(~ paste0("Total_", .), -BaseMetabolite)  # Prefix totals with "Total_"

  # Step 2: Join the totals back to the original dataframe
  data_with_proportions <- data %>%
    mutate(BaseMetabolite = gsub("_M[0-9]+$", "", Metabolite)) %>%
    left_join(totals_df, by = "BaseMetabolite") %>%
    # Step 3: Calculate proportions for M0 and M2
    mutate(across(
      where(is.numeric) & !starts_with("Total_"),
      ~ .x / get(paste0("Total_", cur_column())),
      .names = "Proportion_{col}"
    )) %>%
    # Step 4: Filter to keep only M0 and M2 rows and proportion columns
    filter(grepl("_M[0-9]+$", Metabolite)) %>%
    select(Metabolite, mz, starts_with("Proportion_"))

  # Step 5: Clean up column names (remove Proportion_ prefix and drop Proportion_mz)
  final_df <- data_with_proportions %>%
    select(-Proportion_mz) %>%
    rename_with(~ gsub("Proportion_", "", .), starts_with("Proportion_"))
  
  return(final_df)
}

merged_edf <- normalizeTracer(merged_df)
p_egaba <- plotMetabolite(merged_edf, "GABA")
p_easp <- plotMetabolite(merged_edf, "Aspartate")
p_eglu <- plotMetabolite(merged_edf, "Glutamate")
p_egln <- plotMetabolite(merged_edf, "Glutamine")

merged_endf <- normalizeTracer(merged_ndf)
p_engaba <- plotMetabolite(merged_endf, "GABA")
p_enasp <- plotMetabolite(merged_endf, "Aspartate")
p_englu <- plotMetabolite(merged_endf, "Glutamate")
p_engln <- plotMetabolite(merged_endf, "Glutamine")
```

Plot compile

```{r}
library(patchwork)

p <- (p_glu + p_gaba) / (p_gln + p_asp)
p_n <- (p_nglu + p_ngaba) / (p_ngln + p_nasp)
p_e <- (p_eglu + p_egaba) / (p_egln + p_easp)
p_en <- (p_englu + p_engaba) / (p_engln + p_enasp)
```

```{r}
library(ggpubr)

plotMetabolite2 <- function(data, metabolite_name) {
  # Filter data for the specified metabolite
  metabolite_data <- data[grep(metabolite_name, data$Metabolite), ]
  
  # Reshape the data for easier plotting
  metabolite_long <- melt(
    metabolite_data,
    id.vars = c("Metabolite", "mz"),
    variable.name = "Region",
    value.name = "Intensity"
  )
  
  # Extract Region and Sample details from column names
  metabolite_long <- metabolite_long |>
    mutate(
      Metabolite = sub(".*_(M[0-9]+)", "\\1", Metabolite),
      Sample = sub("_.*", "", Region),        # Extract sample name (e.g., "c5", "c9", "c10")
      Region = gsub("c[0-9]+_", "", Region)  # Remove sample prefixes to get region names
    )
  
  # Compute summary statistics (mean and standard error) for each group
  summary_data <- metabolite_long |>
    group_by(Metabolite, Region) |>
    summarize(
      Mean = mean(Intensity, na.rm = TRUE),
      SE = sd(Intensity, na.rm = TRUE) / sqrt(n()),  # Standard error
      .groups = "drop"
    )
  
  # Conduct pairwise t-tests between regions for each Metabolite
  stat_test <- metabolite_long %>%
    group_by(Metabolite) %>%
    t_test(Intensity ~ Region, paired = FALSE) %>%
    adjust_pvalue(method = "bonferroni") %>%
    mutate(
      p.adj.signif = case_when(
        p.adj <= 0.001 ~ "***",
        p.adj <= 0.01 ~ "**",
        p.adj <= 0.05 ~ "*",
        TRUE ~ "NS"
      )
    )
  
  # Add position for significance annotations
  stat_test <- stat_test %>%
    mutate(y.position = max(summary_data$Mean) + SE * 1.5)

  # Plot with p-value annotations
  ggplot(summary_data, aes(x = Region, y = Mean, fill = Metabolite)) +
    geom_bar(stat = "identity", position = position_dodge(width = 0.9), color = "black", width = 0.7) +  # Bar plot
    geom_errorbar(aes(ymin = Mean - SE, ymax = Mean + SE), position = position_dodge(width = 0.9), width = 0.2) +  # Error bars
    geom_jitter(data = metabolite_long, aes(x = Region, y = Intensity, fill = Metabolite), 
                position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), shape = 21, size = 2, color = "black", alpha = 0.8) +  # Dots for individual points
    scale_fill_brewer(palette = "Set1") +  # Customize bar colors
    scale_color_brewer(palette = "Set1") +  # Match dot colors to bar colors
    theme_minimal() +
    labs(
      title = paste(metabolite_name, "Abundances Across Regions"),
      x = "Brain Region",
      y = paste0(metabolite_name, " Intensities"),
      fill = "Isotopologue",
      color = "Isotopologue"
    ) +
    theme(
      axis.text.x = element_text(size = 16, angle = 45, hjust = 1),  # Increase size of x-axis labels
      axis.title.x = element_text(size = 18),  # Increase size of x-axis title
      axis.title.y = element_text(size = 18),  # Increase size of y-axis title
      plot.title = element_text(size = 20, hjust = 0.5)  # Increase size of title and center it
    ) +
    stat_pvalue_manual(stat_test, label = "p.adj.signif", tip.length = 0.01)
}

```


Extract new set of metabolites

```{r}
ala_isotopologue <- data.frame(
  Metabolite = c("Alanine_M0", "Alanine_M1", "Alanine_M2", "Alanine_M3"),
  Mass = c(90.055509,	91.063339,	92.071169,	93.078999)
)

gaba_isotopologue <- data.frame(
  Metabolite = c("GABA_M0", "GABA_M1", "GABA_M2", "GABA_M3",  "GABA_M4"),
  Mass = c(104.071159,	105.078989,	106.086819,	107.094649,	108.102479)
)

glu_isotopologue <- data.frame(
  Metabolite = c("Glutamate_M0", "Glutamate_M1", "Glutamate_M2", "Glutamate_M3",  "Glutamate_M4", "Glutamate_M5"),
  Mass = c(147.076973,	148.084803,	149.092633,	150.100463,	151.108293,	152.116123)
)

gln_isotopologue <- data.frame(
  Metabolite = c("Glutamine_M0", "Glutamine_M1", "Glutamine_M2", "Glutamine_M3",  "Glutamine_M4", "Glutamine_M5"),
  Mass = c(148.060989,	149.068819,	150.076649,	151.084479,	152.092309,	153.100139)
)

four_metabolites <- rbind(ala_isotopologue, gaba_isotopologue)
four_metabolites <- rbind(four_metabolites, glu_isotopologue)
four_metabolites <- rbind(four_metabolites, gln_isotopologue)

c5_nfiltered2 <- filterMetaboliteTIC(c5_ndata, four_metabolites)
c9_nfiltered2 <- filterMetaboliteTIC(c9_ndata, four_metabolites)
c10_nfiltered2 <- filterMetaboliteTIC(c10_ndata, four_metabolites)

merged_ndf2 <- merge(merge(c5_nfiltered2, c9_nfiltered2), c10_nfiltered2)

```


```{r}
# Use Amir peaks H = 1.00331
ala_isotopologue <- data.frame(
  Metabolite = c("Alanine_M0", "Alanine_M1", "Alanine_M2", "Alanine_M3"),
  Mass = c(90.055479,	91.058779,	92.062079,	93.065379)
)

asp_isotopologue <- data.frame(
  Metabolite = c("Aspartate_M0", "Aspartate_M1", "Aspartate_M2", "Aspartate_M3", "Aspartate_M4"),
  Mass = c(134.045259,	135.048509,	136.051759,	137.055009,	138.058259)
)

gaba_isotopologue <- data.frame(
  Metabolite = c("GABA_M0", "GABA_M1", "GABA_M2", "GABA_M3",  "GABA_M4"),
  Mass = c(104.07095,	105.07434,	106.07773,	107.08112,	108.08451)
)

glu_isotopologue <- data.frame(
  Metabolite = c("Glutamate_M0", "Glutamate_M1", "Glutamate_M2", "Glutamate_M3",  "Glutamate_M4", "Glutamate_M5"),
  Mass = c(148.06102,	149.06433,	150.06764,	151.07095,	152.07426,	153.07757)
)

gln_isotopologue <- data.frame(
  Metabolite = c("Glutamine_M0", "Glutamine_M1", "Glutamine_M2", "Glutamine_M3",  "Glutamine_M4", "Glutamine_M5"),
  Mass = c(147.07694,	148.060065,	149.08319,	150.072315,	151.06944,	152.042565)
)



four_metabolites <- NULL
four_metabolites <- rbind(four_metabolites, ala_isotopologue)
four_metabolites <- rbind(four_metabolites, asp_isotopologue)
four_metabolites <- rbind(four_metabolites, gaba_isotopologue)
four_metabolites <- rbind(four_metabolites, glu_isotopologue)
four_metabolites <- rbind(four_metabolites, gln_isotopologue)

c5_nfiltered3 <- filterMetaboliteTIC(c5_ndata, four_metabolites)
c9_nfiltered3 <- filterMetaboliteTIC(c9_ndata, four_metabolites)
c10_nfiltered3 <- filterMetaboliteTIC(c10_ndata, four_metabolites)

merged_ndf3 <- merge(merge(c5_nfiltered3, c9_nfiltered3), c10_nfiltered3)

p_agaba <- plotMetabolite(merged_ndf3, "GABA")
p_aala <- plotMetabolite(merged_ndf3, "Alanine")
p_aasp <- plotMetabolite(merged_ndf3, "Aspartate")
p_aglu <- plotMetabolite(merged_ndf3, "Glutamate")
p_agln <- plotMetabolite(merged_ndf3, "Glutamine")

p_a <- (p_aglu + p_agaba) / (p_agln + p_aasp) / p_aala

```


```{r}
pv_isotopologue <- data.frame(
  Metabolite = c("Pyruvate_M0", "Pyruvate_M1", "Pyruvate_M2", "Pyruvate_M3"),
  Mass = c(89.053845,	90.031645,	91.039445,	92.047245)
)

gaba_isotopologue <- data.frame(
  Metabolite = c("GABA_M0", "GABA_M1", "GABA_M2", "GABA_M3",  "GABA_M4"),
  Mass = c(104.07095,	105.07434,	106.07773,	107.08112,	108.08451)
)

sc_isotopologue <- data.frame(
  Metabolite = c("Succinate_M0", "Succinate_M1", "Succinate_M2", "Succinate_M3", "Succinate_M4"),
  Mass = c(119.08481,	120.1221,	121.12401,	122.08781,	123.07561)
)

fm_isotopologue <- data.frame(
  Metabolite = c("Fumarate_M0", "Fumarate_M1", "Fumarate_M2", "Fumarate_M3", "Fumarate_M4"),
  Mass = c(117.05876,	118.02656,	119.04436,	120.04216,	121.04996)
)

gln_isotopologue <- data.frame(
  Metabolite = c("Glutamine_M0", "Glutamine_M1", "Glutamine_M2", "Glutamine_M3",  "Glutamine_M4", "Glutamine_M5"),
  Mass = c(147.07694,	148.060065,	149.08319,	150.072315,	151.06944,	152.042565)
)

glu_isotopologue <- data.frame(
  Metabolite = c("Glutamate_M0", "Glutamate_M1", "Glutamate_M2", "Glutamate_M3",  "Glutamate_M4", "Glutamate_M5"),
  Mass = c(148.06102,	149.06433,	150.06764,	151.07095,	152.07426,	153.07757)
)


six_metabolites <- NULL
six_metabolites <- rbind(six_metabolites, pv_isotopologue)
six_metabolites <- rbind(six_metabolites, gaba_isotopologue)
six_metabolites <- rbind(six_metabolites, sc_isotopologue)
six_metabolites <- rbind(six_metabolites, fm_isotopologue)
six_metabolites <- rbind(six_metabolites, gln_isotopologue)
six_metabolites <- rbind(six_metabolites, glu_isotopologue)

c5_6mets <- filterMetaboliteTIC(c5_ndata, six_metabolites)
c9_6mets <- filterMetaboliteTIC(c9_ndata, six_metabolites)
c10_6mets <- filterMetaboliteTIC(c10_ndata, six_metabolites)

merged_final <- merge(merge(c5_6mets, c9_6mets), c10_6mets)

p_pv <- plotMetabolite(merged_final, "Pyruvate")
p_gaba <- plotMetabolite(merged_final, "GABA")
p_sc <- plotMetabolite(merged_final, "Succinate")
p_fm <- plotMetabolite(merged_final, "Fumarate")
p_gln <- plotMetabolite(merged_final, "Glutamine")
p_glu <- plotMetabolite(merged_final, "Glutamate")

p_a <- (p_pv + p_gaba) / (p_sc + p_fm) / (p_gln + p_glu)

write.csv(merged_final, "final_msi_data.csv", row.names = FALSE)

# code location on labarchive: https://mynotebook.labarchives.com/NzYyOTM4Ljh8NTg2ODc2LzU4Njg3Ni9Ob3RlYm9vay8xMjgwOTM4ODM1fDE5MzY2OTAuNzk5OTk5OTk5OA==/page/1712891-2606
```


Figure heatmap and barplot from file "final_msi_data.csv"
```{r}
#Load the library:
final_data <- read.csv("final_msi_data.csv") %>% 
              dplyr::select(-mz)


#Create a dataframe to make the data suitable for plotting:
final_data_2 <- final_data %>%
  separate(Metabolite, into = c("Metabolite_1", "Ion"), sep = "_") %>%
  pivot_longer(
    cols = starts_with("c"), # Seleccionar las columnas que empiezan con "c"
    names_to = "Tissue",     # Nombre de la nueva columna con las variables originales
    values_to = "Values"     # Nombre de la columna con los valores
  ) %>%
  group_by(Metabolite_1, Tissue) %>%
  mutate(
    Total = sum(Values, na.rm = TRUE),       # Calcular la suma total de los valores por Metabolite_1 y Tissue
    Normalized_Value = Values / Total       # Dividir cada valor por el total
  ) %>%
  ungroup() %>%
  select(-Total) %>%
  mutate(
    Tissue_Group = case_when(
      str_ends(Tissue, "cortex") ~ "Cortex",  # Identificar tejidos que terminan en "cortex"
      str_ends(Tissue, "hippo") ~ "Hippo",    # Identificar tejidos que terminan en "hippo"
      str_ends(Tissue, "cereb") ~ "Cereb"     # Identificar tejidos que terminan en "cereb"
    )
  ) %>%
  group_by(Metabolite_1, Tissue_Group, Ion) %>%
  summarize(
    Avg_Normalized_Value = mean(Normalized_Value, na.rm = TRUE),  # Calcular el promedio
    StdDev_Normalized_Value = sd(Normalized_Value, na.rm = TRUE), # Calcular la desviación estándar
    .groups = "drop"  # Desagrupar después de calcular
  ) %>%
  ungroup() %>% 
  unite("Metabolite", Metabolite_1, Ion, sep = "_")  # Unir las columnas Metabolite_1 e Ion

# Specify the desired metabolite order (reversed for Pyruvate to appear at the top):
desired_order <- rev(c(
  "Pyruvate_M0", "Pyruvate_M1", "Pyruvate_M2", "Pyruvate_M3",
  "Glutamate_M0", "Glutamate_M1", "Glutamate_M2", "Glutamate_M3", "Glutamate_M4", "Glutamate_M5",
  "Glutamine_M0", "Glutamine_M1", "Glutamine_M2", "Glutamine_M3", "Glutamine_M4", "Glutamine_M5",
  "GABA_M0", "GABA_M1", "GABA_M2", "GABA_M3", "GABA_M4",
  "Succinate_M0", "Succinate_M1", "Succinate_M2", "Succinate_M3", "Succinate_M4",
  "Fumarate_M0", "Fumarate_M1", "Fumarate_M2", "Fumarate_M3", "Fumarate_M4"
))

# Update the Metabolite column to follow the reversed desired order
final_data_2 <- final_data_2 %>%
  mutate(Metabolite = factor(Metabolite, levels = desired_order))

# Generate the ggplot heatmap with reversed y-axis
final_data_2_heatmap <- final_data_2 %>%
  ggplot(aes(x = Tissue_Group, y = Metabolite, fill = Avg_Normalized_Value)) +
  geom_tile(color = "grey") +  # Add borders for better readability
  scale_fill_gradient2(
    low = "blue", mid = "white", high = "red", midpoint = 0.3,  # Set midpoint to 0.3
    na.value = "grey"  # Set color for NA values
  ) +
  labs(
    x = "Tissue Group",
    y = "Metabolite",
    fill = "Avg Normalized Value"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # Rotate x-axis text for readability
    axis.text.y = element_text(size = 8),              # Adjust y-axis text size
    panel.grid.major = element_blank(),                # Remove grid lines
    panel.grid.minor = element_blank()
  )

ggsave(final_data_2_heatmap, filename = "final_data_2_heatmap.pdf", height = 7, width = 4)


#Barplot with Glutamate, Glutamine, GABA, and Pyruvate:
final_data_2_barplot <- final_data_2 %>%
  separate(Metabolite, into = c("Metabolite_1", "Ion"), sep = "_") %>%
  filter(Metabolite_1 %in% c("Glutamate", "Glutamine", "GABA", "Fumarate"),
         Ion %in% c("M0", "M2"),
         Tissue_Group %in% c("Cereb", "Cortex")) %>%
  mutate(Metabolite_1 = factor(Metabolite_1, levels = c("Glutamate", "Glutamine", "GABA", "Fumarate"))) %>%  # Set facet order
  ggplot(aes(x = Tissue_Group, y = Avg_Normalized_Value, fill = Ion)) +
  geom_errorbar(aes(ymin = Avg_Normalized_Value - StdDev_Normalized_Value,
                    ymax = Avg_Normalized_Value + StdDev_Normalized_Value, color = Ion),
                position = position_dodge(width = 1), width = 0.2) +  # Error bars
  geom_bar(stat = "identity", position = position_dodge(width = 1)) +  # Bar plot with dodge for grouping
  facet_wrap(~ Metabolite_1, scales = "free_y") +  # Facet by metabolite
  scale_color_manual(values = c("dodgerblue1", "red")) +  # Color error bars
  scale_fill_manual(values = c("dodgerblue1", "red")) +  # Color bars
  labs(
    x = "Brain Region",
    y = "Avg Normalized Value",
    fill = "Isotopologue"
  ) +
  scale_y_continuous(name = "Ratio", expand = c(0, 0), breaks = seq(0, 1.2, 0.2)) +
  theme(
    axis.title.y = element_text(color = "black"),
    axis.title.y.right = element_text(color = "blue"),
    axis.text = element_text(size = 12, color = "black", family = "Helvetica"),
    axis.title = element_text(size = 12, face = "bold", color = "black"),
    axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 1.2, color = "black")
  ) +
  coord_cartesian(ylim = c(0, 1))

  
ggsave(final_data_2_barplot, filename = "final_data_2_barplot.pdf", height = 6, width = 6)

```


Figure 4C Cortex

Set up the working directory
```{r}
setwd("/Users/isaacmarin-valencia/Desktop/STAR_Protocol_Cereb/Cortex")

```


Open the RData file (remove any RData loaded before)
```{r}
load("~/Desktop/STAR_Protocol_Cereb/Cortex/cortext.RData")
```

Plot test. Plot for the figure
```{r}
# Original table1:

table1 <- tibble::tibble(
  Mainclass = c("Ornithine alkaloids", "Pyridine alkaloids", "Other alkaloids", 
                "Benzenes", "Monosaccharides", "Fatty acids", 
                "Other fatty acyls", "Pyrimidines", "Other nucleic acids", 
                "Amino acids and peptides", "Other organic acids", 
                "Organonitrogen compounds", "Other organic nitrogen compounds", 
                "Azoles", "Other organoheterocyclic compounds", 
                "Cinnamic acids and derivatives", "Bile acids"),
  Mainclass.color = c("#F8766DB5", "#F8766DB8", "#F8766DBB", 
                      "#DE8C00BE", "#DEAC00C2", "#7CAE00C4", 
                      "#7CAE00C8", "#00C08BCA", "#00C08BCE", 
                      "#00B4F0D0", "#00B4F0D3", "#619CFFD6", 
                      "#619CFFDA", "#C77CFFDC", "#C77CFFE0", 
                      "#F564E3E2", "#FF64B0E5")
)

long_barplot1 <- summarized_for_barplot |>
  pivot_longer(cols = starts_with("Intensity"),
               names_to = "Cluster",
               values_to = "Intensity") |>
  mutate(Cluster = sub("Intensity\\.cluster", "", Cluster),
         Cluster = factor(Cluster, levels = as.character(1:20))) 

# Assign consistent colors from table1 to table_subset
long_barplot1 <- long_barplot1 %>%
  left_join(table1, by = "Mainclass")

p1 <- ggplot(long_barplot1, aes(x = Cluster, y = Intensity, fill = Superclass)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(title = "Stacked Barplot: Superclass by Clusters",
       x = "Cluster",
       y = "Intensity",
       fill = "Super class") +
 scale_y_continuous(name= "Ratio", expand=c(0,0))+
 theme(axis.text.x = element_text(angle = 0, hjust = 0.5))

p1

ggsave(p1 ,filename = "p1_cortex.pdf",width = 7,height=4)

```


Figure 4C Cerebellum

Set up the working directory
```{r}
setwd("/Users/isaacmarin-valencia/Desktop/STAR_Protocol_Cereb/Cereb")

```


Open the RData file
```{r}
load("~/Desktop/STAR_Protocol_Cereb/Cereb/cereb_cluster_analysis.RData")
```

```{r}
# Original table1:

table1 <- tibble::tibble(
  Mainclass = c("Ornithine alkaloids", "Pyridine alkaloids", "Other alkaloids", 
                "Benzenes", "Monosaccharides", "Fatty acids", 
                "Other fatty acyls", "Pyrimidines", "Other nucleic acids", 
                "Amino acids and peptides", "Other organic acids", 
                "Organonitrogen compounds", "Other organic nitrogen compounds", 
                "Azoles", "Other organoheterocyclic compounds", 
                "Cinnamic acids and derivatives", "Bile acids"),
  Mainclass.color = c("#F8766DB5", "#F8766DB8", "#F8766DBB", 
                      "#DE8C00BE", "#DEAC00C2", "#7CAE00C4", 
                      "#7CAE00C8", "#00C08BCA", "#00C08BCE", 
                      "#00B4F0D0", "#00B4F0D3", "#619CFFD6", 
                      "#619CFFDA", "#C77CFFDC", "#C77CFFE0", 
                      "#F564E3E2", "#FF64B0E5")
)

long_barplot1 <- summarized_for_barplot |>
  pivot_longer(cols = starts_with("Intensity"),
               names_to = "Cluster",
               values_to = "Intensity") |>
  mutate(Cluster = sub("Intensity\\.cluster", "", Cluster),
         Cluster = factor(Cluster, levels = as.character(1:20))) 

# Assign consistent colors from table1 to table_subset
long_barplot1 <- long_barplot1 %>%
  left_join(table1, by = "Mainclass")

long_barplot1 %>% 
  distinct(Superclass, .keep_all = TRUE)

p1 <- ggplot(long_barplot1, aes(x = Cluster, y = Intensity, fill = Superclass)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(title = "Stacked Barplot: Superclass by Clusters",
       x = "Cluster",
       y = "Intensity",
       fill = "Super class") +
 scale_y_continuous(name= "Ratio", expand=c(0,0))+
 theme(axis.text.x = element_text(angle = 0, hjust = 0.5))

p1

ggsave(p1 ,filename = "p1_cereb.pdf",width = 7,height=4)


```
